{%- liquid
  assign section_id = section.id
  assign related_products = product.metafields.custom.other_products.value
  assign max_products = section.settings.max_products | default: 4
-%}

{%- style -%}
  .section-{{ section_id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section_id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

{%- if related_products and related_products.size > 0 -%}
  <div class="related-products-section section-{{ section_id }}-padding" data-section-id="{{ section_id }}">
    <div class="section">
      <div class="related-products-section__header">
        {%- if section.settings.title != blank -%}
          <h2 class="related-products-section__title">
            {{ section.settings.title }}
          </h2>
        {%- endif -%}
        
        {%- if related_products.size > 1 -%}
          <div class="related-products-section__navigation">
            <button type="button" class="related-products-section__arrow related-products-section__arrow--prev" aria-label="Previous">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button type="button" class="related-products-section__arrow related-products-section__arrow--next" aria-label="Next">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        {%- endif -%}
      </div>

      <div class="related-products-section__carousel" data-carousel-id="{{ section_id }}">
        {%- for related_product in related_products limit: max_products -%}
          {%- render 'related-product-card', prod: related_product, index: forloop.index -%}
        {%- endfor -%}
      </div>
    </div>
  </div>

  <script type="text/javascript">
    (function() {
      // Initialize all product cards
      document.querySelectorAll('.related-product-card').forEach(function(card) {
        const form = card.querySelector('[data-product-form]');
        const addBtn = card.querySelector('[data-add-to-cart]');
        const variantInput = card.querySelector('[data-variant-input]');

        if (form && addBtn && variantInput) {
          form.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const variantId = parseInt(variantInput.value);
            if (!variantId || addBtn.disabled) return;

            // Show loading state
            addBtn.classList.add('loading');
            addBtn.disabled = true;
            const textSpan = addBtn.querySelector('[data-add-to-cart-text]');
            const originalText = textSpan ? textSpan.textContent : 'Add To Cart';
            if (textSpan) {
              textSpan.textContent = 'Adding...';
            }

            // Function to trigger cart drawer - open it directly
            function triggerCartDrawer() {
              // Wait a bit for cart to update, then open drawer
              setTimeout(function() {
                // Find the quick-cart component
                const quickCart = document.querySelector('[data-section-type="quick-cart"], .quick-cart');
                if (quickCart) {
                  const cartWrapper = quickCart.querySelector('.quick-cart__wrapper');
                  if (cartWrapper) {
                    // Add active class to open the drawer
                    cartWrapper.classList.add('active');
                    document.body.setAttribute('data-fluorescent-overlay-open', 'true');
                    
                    // Also trigger the apps event as backup
                    if (document.dispatchEvent) {
                      document.dispatchEvent(new CustomEvent('apps:product-added-to-cart'));
                    }
                  }
                }
              }, 350);
            }

            // Use theme's cart API
            if (window.cart && typeof window.cart.addItemById === 'function') {
              window.cart.addItemById(variantId, 1).then(function(result) {
                addBtn.classList.remove('loading');
                addBtn.disabled = false;
                if (textSpan) {
                  textSpan.textContent = originalText;
                }
                
                // Trigger cart drawer
                triggerCartDrawer();
              }).catch(function(error) {
                console.error('Error adding to cart:', error);
                addBtn.classList.remove('loading');
                addBtn.disabled = false;
                if (textSpan) {
                  textSpan.textContent = originalText;
                }
                alert('Unable to add product to cart. Please try again.');
              });
            } else {
              // Fallback: use Shopify's cart API directly
              fetch('/cart/add.js', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  items: [{
                    id: variantId,
                    quantity: 1
                  }]
                })
              }).then(function(response) {
                if (!response.ok) {
                  throw new Error('Failed to add to cart');
                }
                return response.json();
              }).then(function(data) {
                addBtn.classList.remove('loading');
                addBtn.disabled = false;
                if (textSpan) {
                  textSpan.textContent = originalText;
                }
                
                // Trigger cart drawer events
                triggerCartDrawer();
              }).catch(function(error) {
                console.error('Error:', error);
                addBtn.classList.remove('loading');
                addBtn.disabled = false;
                if (textSpan) {
                  textSpan.textContent = originalText;
                }
                alert('Unable to add product to cart. Please try again.');
              });
            }
          });
        }
      });
    })();
  </script>

  <style>
    .related-products-section {
      background: #fff;
    }

    .related-products-section__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .related-products-section__title {
        font-size: 34px;
        font-weight: 700;
        color: #000;
        margin: 0;
        font-family: 'Inter', sans-serif;
        line-height: 100%;
    }

    .related-products-section__navigation {
      display: flex;
      gap: 8px;
    }

    .related-products-section__arrow {
        width: 28.33px;
        height: 28.33px;
        border-radius: 50%;
        background: #d5c8c8;
        border: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #000;
        padding: 0;
    }

    .related-products-section__arrow:hover {
      background: #000;
      color: #fff;
      border-color: #000;
    }

    .related-products-section__arrow svg {
        width: 18px;
        height: 18px;
    }

    .related-products-section__carousel {
      position: relative;
      width: 100%;
    }

    .related-products-section__carousel .slick-list {
      margin: 0 -10px;
      overflow: hidden;
    }

    .related-products-section__carousel .slick-track {
      display: flex;
      align-items: stretch;
    }

    .related-products-section__carousel .slick-slide {
      padding: 0 10px;
      box-sizing: border-box;
      height: auto;
    }

    .related-products-section__carousel .slick-slide > div {
      width: 100%;
      height: 100%;
    }

    @media (max-width: 480px) {
      .related-products-section__carousel .slick-list {
        margin: 0 -8px;
      }
      
      .related-products-section__carousel .slick-slide {
        padding: 0 8px;
      }
    }

    /* Related Product Card Styles */
    .related-product-card {
      background: #E4E5E9;
      border-radius: 12px;
      padding: 0;
      position: relative;
      transition: transform 0.3s ease;
      overflow: hidden;
      display: flex !important;
      flex-direction: column;
      height: 100%;
      align-items: stretch;
      justify-content: flex-end;
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    .related-product-card__image-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: 8px 8px 0 0;
      background: #fff;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    .related-product-card:hover .related-product-card__image-wrapper {
      transform: translate3d(0, -10px, 0);
    }

    .related-product-card__image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform;
      backface-visibility: hidden;
    }

    .related-product-card__image-placeholder {
      width: 100%;
      height: 100%;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .related-product-card__rating {
      position: absolute;
      bottom: 8px;
      left: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      border-radius: 50px;
      z-index: 2;
    }

    .related-product-card__star-icon {
      width: 16px;
      height: 16px;
      color: #ffc107;
      fill: #ffc107;
    }

    .related-product-card__content-wrapper {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      padding: 8px;
      border-radius: 7px;
      position: relative;
      margin-bottom: 0;
      min-height: 0;
      padding-bottom: 60px;
      will-change: transform;
      backface-visibility: hidden;
    }
    
    .main__wrapper__related__product {
      padding: 0 8px 8px 8px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      /* flex: 1; */
      display: flex;
      flex-direction: column;
      min-height: 0;
      margin-bottom: 0;
      height: auto;
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    .related-product-card:hover .main__wrapper__related__product {
      transform: translate3d(0, -10px, 0);
    }

    .related-product-card__variants {
      margin-bottom: 12px;
    }

    .related-product-card__model-swatches {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .related-product-card__swatch {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      overflow: hidden;
      display: block;
      text-decoration: none;
      transition: border-color 0.3s ease;
      flex-shrink: 0;
    }

    .related-product-card__swatch:hover {
      border-color: #000;
    }

    .related-product-card__swatch.active {
      border-color: #000;
      border-width: 2px;
    }

    .related-product-card__swatch img {
      width: 36px;
      height: 36px;
      object-fit: cover;
      display: block;
    }

    .related-product-card__title {
      font-family: 'Inter', sans-serif;
      line-height: 100%;
      letter-spacing: 0;
      font-weight: 500;
      font-size: 15px;
      margin: 10px 0;
      color: #000 !important;
    }

    .related-product-card__title a {
      color: inherit;
      text-decoration: none;
    }

    .related-product-card__title a:hover {
      text-decoration: underline;
    }

    .related-product-card__price {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 0;
    }

    .related-product-card__current-price {
      font-size: 18px;
      font-weight: 700;
      color: #000;
    }

    .related-product-card__compare-price {
      font-size: 16px;
      color: #999;
      text-decoration: line-through;
    }

    .related-product-card__add-to-cart-wrapper {
      opacity: 0;
      transform: translate3d(0, 10px, 0);
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                  transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      position: absolute;
      bottom: 8px;
      left: 8px;
      right: 8px;
      z-index: 2;
      will-change: opacity, transform;
      backface-visibility: hidden;
      display: block;
    }

    .related-product-card:hover .related-product-card__add-to-cart-wrapper {
      opacity: 1;
      transform: translate3d(0, 0, 0);
      pointer-events: auto;
    }

    .related-product-card__add-to-cart-form {
      margin: 0;
    }

    .related-product-card__add-to-cart-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: #000;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      font-family: 'Inter', sans-serif;
      width: 100%;
    }

    .related-product-card__add-to-cart-btn:hover {
      background: #333;
    }

    .related-product-card__add-to-cart-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .related-product-card__cart-icon {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      fill: none;
    }
    @media screen and (max-width:991px){
      .related-product-card__content-wrapper{
        padding-bottom: 25px;
      }
      .related-product-card__add-to-cart-wrapper{
        opacity: 1;
        position: relative;
        bottom: auto;
        left: auto;
        right: auto;
      }
    }
    @media (max-width: 768px) {
      .related-products-section__title {
        font-size: 24px;
      }
      .related-product-card__rating-number {
        font-size: 10.45px !important;
      }
      .related-product-card__title{
        font-size: 13.07px;
        color: #000;
      }
      .related-product-card__current-price{
        font-size: 12.2px !important;
      }
      .related-product-card__swatch,
      .related-product-card__swatch img {
        width: 32.6px;
        height: 31.6px;
      }
    }
  </style>

  <script>
    (function() {
      function initRelatedProductsSlider() {
        const section = document.querySelector('[data-section-id="{{ section_id }}"]');
        if (!section) return;

        const carousel = section.querySelector('.related-products-section__carousel');
        const prevBtn = section.querySelector('.related-products-section__arrow--prev');
        const nextBtn = section.querySelector('.related-products-section__arrow--next');

        if (!carousel) return;

        // Wait for jQuery and Slick to be available
        if (typeof jQuery === 'undefined' || !jQuery.fn.slick) {
          setTimeout(initRelatedProductsSlider, 100);
          return;
        }

        // Initialize Slick slider
        jQuery(carousel).slick({
          slidesToShow: 4,
          slidesToScroll: 1,
          infinite: false,
          arrows: false,
          dots: false,
          variableWidth: false,
          centerMode: false,
          responsive: [
            {
              breakpoint: 1024,
              settings: {
                slidesToShow: 3,
                slidesToScroll: 1
              }
            },
            {
              breakpoint: 768,
              settings: {
                slidesToShow: 2,
                slidesToScroll: 1
              }
            },
            {
              breakpoint: 480,
              settings: {
                slidesToShow: 1.3,
                slidesToScroll: 1,
                centerMode: false
              }
            }
          ]
        });

        // Navigation buttons
        if (prevBtn) {
          prevBtn.addEventListener('click', function() {
            jQuery(carousel).slick('slickPrev');
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', function() {
            jQuery(carousel).slick('slickNext');
          });
        }
      }

      // Initialize on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initRelatedProductsSlider);
      } else {
        initRelatedProductsSlider();
      }
    })();
  </script>
{%- endif -%}

<style>
    .related-product-card {
      background: #E4E5E9;
      border-radius: 12px;
      padding: 0;
      position: relative;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    .related-product-card__image-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: 8px 8px 0 0;
      background: #fff;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    .related-product-card:hover .related-product-card__image-wrapper {
      transform: translate3d(0, -10px, 0);
    }

  .related-product-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
    backface-visibility: hidden;
  }

  .related-product-card__image-placeholder {
    width: 100%;
    height: 100%;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .related-product-card__star-icon {
    width: 16px;
    height: 16px;
    color: #ffc107;
    fill: #ffc107;
  }

  .related-product-card__rating-number {
    font-size: 12px;
    font-weight: 500;
    color: #000000;
    line-height: 100%;
    letter-spacing: 0;
  }

  .related-product-card__hover-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    z-index: 3;
    border-radius: 8px;
  }

  .related-product-card:hover .related-product-card__hover-overlay {
    opacity: 1;
    visibility: visible;
  }

  .related-product-card__add-to-cart-form {
    margin: 0;
  }

  .related-product-card__add-to-cart-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #000;
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
    font-family: 'Inter', sans-serif;
  }

  .related-product-card__add-to-cart-btn:hover {
    background: #333;
  }

  .related-product-card__add-to-cart-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .related-product-card__cart-icon {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
  }

  .related-product-card__variants {
    margin-bottom: 12px;
  }

  .related-product-card__model-swatches {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .related-product-card__swatch:hover {
    border-color: #000;
  }

  .related-product-card__swatch.active {
    border-color: #000;
    border-width: 2px;
  }

  .related-product-card__title a {
    color: inherit;
    text-decoration: none;
  }

  .related-product-card__title a:hover {
    text-decoration: underline;
  }

  .related-product-card__price {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .related-product-card__current-price {
    font-family: 'Inter', sans-serif;
    font-weight: 600;
    line-height: 100%;
    letter-spacing: 0;
    font-size: 14px;
    color: #000;
  }

  .related-product-card__compare-price {
    font-size: 16px;
    color: #999;
    text-decoration: line-through;
  }
</style>

{% schema %}
{
  "name": "Related Products",
  "tag": "section",
  "class": "custom-related-products-section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Related Products"
    },
    {
      "type": "range",
      "id": "max_products",
      "min": 2,
      "max": 12,
      "step": 1,
      "label": "Maximum Products",
      "default": 4
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 60
    }
  ],
  "presets": [
    {
      "name": "Related Products"
    }
  ]
}
{% endschema %}

